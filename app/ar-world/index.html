<!DOCTYPE html>
<html>
  <head>
    <title>AR Location Finder</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: "Inter", sans-serif;
        background-color: #000; /* Ensure background is dark for camera feed */
      }

      /* --- UI OVERLAYS --- */
      #locationInfoDisplay {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9em;
        z-index: 1000;
        pointer-events: none;
      }

      #distanceDisplay {
        margin-top: 5px; /* Spacing below lat/lon */
        font-size: 0.8em;
        color: #add8e6; /* Light blue for distance */
      }

      .arjs-loader {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .arjs-loader div {
        text-align: center;
        font-size: 1.2em;
        color: white;
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.6);
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      #messageBox {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(248, 215, 218, 0.9);
        color: #721c24;
        padding: 20px;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        text-align: center;
        max-width: 80%;
        font-size: 0.9em;
      }

      #messageBox button {
        background-color: #dc3545;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 15px;
        font-size: 1em;
        transition: background-color 0.3s ease;
      }

      #messageBox button:hover {
        background-color: #c82333;
      }

      /* --- DESCRIPTION POPUP --- */
      #descriptionPopup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 25px;
        border-radius: 12px;
        z-index: 10001;
        max-width: 90%;
        width: 300px;
        box-sizing: border-box;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      #descriptionPopup h3 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.5em;
        color: #4caf50;
      }

      #descriptionPopup p {
        font-size: 1em;
        line-height: 1.4;
        margin-bottom: 20px;
      }

      #descriptionPopup button.close-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        color: white;
        font-size: 2em;
        cursor: pointer;
        line-height: 1;
        padding: 5px;
      }

      #descriptionPopup button.close-btn:hover {
        color: #f44336;
      }

      #audioControls button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      #audioControls button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div id="locationInfoDisplay">
      Latitude: <span id="currentLat">--.--</span> <br />
      Longitude: <span id="currentLon">--.--</span> <br />
      <span id="distanceDisplay">Distance to nearest: -- m</span>
    </div>

    <div class="arjs-loader">
      <div>
        Loading AR experience...<br />Please grant location and camera
        permissions.
      </div>
    </div>

    <div id="messageBox">
      <p id="messageText"></p>
      <button
        onclick="document.getElementById('messageBox').style.display = 'none';"
      >
        OK
      </button>
    </div>

    <div id="descriptionPopup">
      <button
        class="close-btn"
        onclick="document.getElementById('descriptionPopup').style.display = 'none';"
      >
        &times;
      </button>
      <h3 id="popupItemName"></h3>
      <p id="popupDescription"></p>
      <div id="audioControls">
        <button id="playAudioBtn" disabled>
          Play Audio (Feature Coming Soon)
        </button>
        <audio id="itemAudio" src=""></audio>
      </div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
      gps-entity-place="true"
      renderer="logarithmicDepthBuffer: true;"
    >
      <a-camera
        id="camera"
        look-controls-enabled="false"
        arjs-device-orientation-controls="smoothingFactor: 0.1"
        gps-new-camera="gpsMinDistance: 1"
      >
      </a-camera>
    </a-scene>

    <script>
      const itemsToPlace = [
        {
          name: "Mysterious Box",
          model: "assets/toon_cat_free.glb",
          scale: "1 1 1",
          description:
            "This ancient box, covered in strange glyphs, seems to pulse with a faint energy. Perhaps it holds a secret!",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"
        },
        {
          name: "Glimmering Orb",
          model: "assets/wolf_with_animations.glb",
          scale: "0.8 0.8 0.8",
          description:
            "A perfectly smooth orb, reflecting light in mesmerizing patterns. Legends say it can reveal hidden truths.",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"
        },
        {
          name: "Weathered Totem",
          model: "assets/toon_cat_free.glb",
          scale: "1.2 1.2 1.2",
          description:
            "Carved from an unknown wood, this totem stands as a silent guardian, weathered by countless seasons.",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3"
        },
        {
          name: "Ancient Scroll",
          model: "assets/wolf_with_animations.glb",
          scale: "0.9 0.9 0.9",
          description:
            "Unfurling slightly, this scroll hints at forgotten lore and maps to untold riches.",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3"
        },
        {
          name: "Floating Gem",
          model: "assets/toon_cat_free.glb",
          scale: "1.1 1.1 1.1",
          description:
            "This crystalline gem hums with a soft vibration, seemingly defying gravity as it hovers.",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3"
        }
      ];

      const scene = document.querySelector("a-scene");
      const loader = document.querySelector(".arjs-loader");
      const messageBox = document.getElementById("messageBox");
      const messageText = document.getElementById("messageText");
      const currentLatSpan = document.getElementById("currentLat");
      const currentLonSpan = document.getElementById("currentLon");
      const distanceDisplay = document.getElementById("distanceDisplay"); // New element
      const descriptionPopup = document.getElementById("descriptionPopup");
      const popupItemName = document.getElementById("popupItemName");
      const popupDescription = document.getElementById("popupDescription");
      const playAudioBtn = document.getElementById("playAudioBtn");
      const itemAudio = document.getElementById("itemAudio");

      let itemsPlaced = false;
      let placedEntities = []; // Array to store references to placed entities

      /**
       * Calculates the distance between two geographical points (Haversine formula).
       * @param {number} lat1 - Latitude of point 1.
       * @param {number} lon1 - Longitude of point 1.
       * @param {number} lat2 - Latitude of point 2.
       * @param {number} lon2 - Longitude of point 2.
       * @returns {number} Distance in meters.
       */
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // metres
        const φ1 = (lat1 * Math.PI) / 180; // φ, λ in radians
        const φ2 = (lat2 * Math.PI) / 180;
        const Δφ = ((lat2 - lat1) * Math.PI) / 180;
        const Δλ = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
          Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        const d = R * c; // in metres
        return d;
      }

      function showMessage(message) {
        messageText.textContent = message;
        messageBox.style.display = "block";
      }

      /**
       * Updates the on-screen Latitude/Longitude display and calculates distance to nearest model.
       * @param {GeolocationPosition} position - The current geolocation position.
       */
      function updateLocationDisplay(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        currentLatSpan.textContent = userLat.toFixed(6);
        currentLonSpan.textContent = userLon.toFixed(6);

        // Calculate distance to nearest placed model
        let minDistance = Infinity;
        if (placedEntities.length > 0) {
          placedEntities.forEach((entity) => {
            const itemGps = entity.getAttribute("gps-entity-place");
            if (itemGps) {
              const itemLat = parseFloat(itemGps.latitude);
              const itemLon = parseFloat(itemGps.longitude);
              const dist = calculateDistance(
                userLat,
                userLon,
                itemLat,
                itemLon
              );
              if (dist < minDistance) {
                minDistance = dist;
              }
            }
          });
          distanceDisplay.textContent = `Distance to nearest: ${minDistance.toFixed(
            1
          )} m`;
        } else {
          distanceDisplay.textContent = `Distance to nearest: -- m`;
        }

        if (!itemsPlaced) {
          placeRandomItems(userLat, userLon);
          itemsPlaced = true;
        }
      }

      function handleLocationError(error) {
        loader.style.display = "none";
        let errorMessage = "Error getting your location: ";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage +=
              "User denied the request for Geolocation. Please enable location access in your browser settings.";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage +=
              "Location information is unavailable (e.g., GPS signal lost).";
            break;
          case error.TIMEOUT:
            errorMessage +=
              "The request to get user location timed out. Please ensure good GPS signal.";
            break;
          case error.UNKNOWN_ERROR:
            errorMessage += "An unknown error occurred.";
            break;
        }
        showMessage(errorMessage);
        console.error("Geolocation error:", error);
      }

      /**
       * Places random AR items around the user's initial location.
       * @param {number} userLat - User's latitude.
       * @param {number} userLon - User's longitude.
       */
      function placeRandomItems(userLat, userLon) {
        loader.style.display = "none";

        // Changed from 20 feet to 10 feet (~3.048 meters)
        const desiredDistanceMeters = 3.048;
        const numberOfItems = 5;

        for (let i = 0; i < numberOfItems; i++) {
          const randomItem =
            itemsToPlace[Math.floor(Math.random() * itemsToPlace.length)];

          const randomAngle = Math.random() * 2 * Math.PI;

          const dx_meters = desiredDistanceMeters * Math.cos(randomAngle);
          const dy_meters = desiredDistanceMeters * Math.sin(randomAngle);

          const meters_per_degree_lat = 111139;
          const meters_per_degree_lon =
            111139 * Math.cos((userLat * Math.PI) / 180);

          const offsetLat = dy_meters / meters_per_degree_lat;
          const offsetLon = dx_meters / meters_per_degree_lon;

          const itemLat = userLat + offsetLat;
          const itemLon = userLon + offsetLon;

          const itemEntity = document.createElement("a-entity");
          itemEntity.setAttribute(
            "gps-entity-place",
            `latitude: ${itemLat}; longitude: ${itemLon};`
          );
          itemEntity.setAttribute("gltf-model", randomItem.model);
          itemEntity.setAttribute("scale", randomItem.scale);
          itemEntity.setAttribute("look-at", "#camera");
          itemEntity.setAttribute("item-data", JSON.stringify(randomItem));
          itemEntity.setAttribute("cursor-listener", "");

          const textEntity = document.createElement("a-text");
          textEntity.setAttribute("value", randomItem.name);
          textEntity.setAttribute("align", "center");
          textEntity.setAttribute("color", "white");
          textEntity.setAttribute("wrap-count", "20");
          textEntity.setAttribute("position", "0 1.5 0");
          textEntity.setAttribute("scale", "2 2 2");
          itemEntity.appendChild(textEntity);

          scene.appendChild(itemEntity);
          placedEntities.push(itemEntity); // Store reference to entity

          console.log(
            `Placed ${randomItem.name} at Lat: ${itemLat.toFixed(
              6
            )}, Lon: ${itemLon.toFixed(
              6
            )} (Approx. ${desiredDistanceMeters}m from user's initial location)`
          );
        }
      }

      scene.addEventListener("loaded", () => {
        if (navigator.geolocation) {
          // Use watchPosition to continuously get updates for display and distance calculation
          navigator.geolocation.watchPosition(
            updateLocationDisplay,
            handleLocationError,
            {
              enableHighAccuracy: true,
              timeout: 20000,
              maximumAge: 0
            }
          );
        } else {
          loader.style.display = "none";
          showMessage(
            "Geolocation is not supported by your browser. This AR experience requires geolocation to function."
          );
          console.error("Geolocation is not supported by this browser.");
        }
      });

      AFRAME.registerComponent("cursor-listener", {
        init: function () {
          this.el.addEventListener("click", function (evt) {
            const itemData = JSON.parse(this.el.getAttribute("item-data"));

            popupItemName.textContent = itemData.name;
            popupDescription.textContent = itemData.description;

            if (itemData.audioSrc) {
              itemAudio.src = itemData.audioSrc;
              playAudioBtn.disabled = false;
              playAudioBtn.textContent = "Play Audio";
              playAudioBtn.onclick = () => {
                if (itemAudio.paused) {
                  itemAudio.play();
                  playAudioBtn.textContent = "Pause Audio";
                } else {
                  itemAudio.pause();
                  playAudioBtn.textContent = "Play Audio";
                }
              };
            } else {
              playAudioBtn.disabled = true;
              playAudioBtn.textContent = "No Audio Available";
              itemAudio.src = "";
            }

            descriptionPopup.style.display = "block";
            console.log(`Clicked on: ${itemData.name}`);
          });
        }
      });

      descriptionPopup
        .querySelector(".close-btn")
        .addEventListener("click", () => {
          itemAudio.pause();
          itemAudio.currentTime = 0;
          playAudioBtn.textContent = "Play Audio (Feature Coming Soon)";
        });
    </script>
  </body>
</html>
