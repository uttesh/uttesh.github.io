<!DOCTYPE html>
<html>
  <head>
    <title>AR Location Finder</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: "Inter", sans-serif;
      }

      /* --- UI OVERLAYS --- */
      #locationDisplay {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9em;
        z-index: 1000; /* Above AR scene */
        pointer-events: none; /* Allows clicks to pass through to AR elements */
      }

      .arjs-loader {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .arjs-loader div {
        text-align: center;
        font-size: 1.2em;
        color: white;
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.6);
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      #messageBox {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(
          248,
          215,
          218,
          0.9
        ); /* Light red, semi-transparent */
        color: #721c24;
        padding: 20px;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        text-align: center;
        max-width: 80%;
        font-size: 0.9em;
      }

      #messageBox button {
        background-color: #dc3545;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 15px;
        font-size: 1em;
        transition: background-color 0.3s ease;
      }

      #messageBox button:hover {
        background-color: #c82333;
      }

      /* --- DESCRIPTION POPUP --- */
      #descriptionPopup {
        display: none; /* Hidden by default */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7); /* Transparent black background */
        color: white;
        padding: 25px;
        border-radius: 12px;
        z-index: 10001; /* Above other overlays */
        max-width: 90%;
        width: 300px; /* Fixed width for better appearance */
        box-sizing: border-box; /* Include padding in width */
        backdrop-filter: blur(8px); /* Apply blur effect to background */
        -webkit-backdrop-filter: blur(8px); /* Safari support */
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); /* Stronger shadow */
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      #descriptionPopup h3 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.5em;
        color: #4caf50; /* Green highlight for title */
      }

      #descriptionPopup p {
        font-size: 1em;
        line-height: 1.4;
        margin-bottom: 20px;
      }

      #descriptionPopup button.close-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        color: white;
        font-size: 2em;
        cursor: pointer;
        line-height: 1;
        padding: 5px;
      }

      #descriptionPopup button.close-btn:hover {
        color: #f44336; /* Red on hover */
      }

      #audioControls button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      #audioControls button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div id="locationDisplay">
      Latitude: <span id="currentLat">--.--</span> <br />
      Longitude: <span id="currentLon">--.--</span>
    </div>

    <div class="arjs-loader">
      <div>
        Loading AR experience...<br />Please grant location and camera
        permissions.
      </div>
    </div>

    <div id="messageBox">
      <p id="messageText"></p>
      <button
        onclick="document.getElementById('messageBox').style.display = 'none';"
      >
        OK
      </button>
    </div>

    <div id="descriptionPopup">
      <button
        class="close-btn"
        onclick="document.getElementById('descriptionPopup').style.display = 'none';"
      >
        &times;
      </button>
      <h3 id="popupItemName"></h3>
      <p id="popupDescription"></p>
      <div id="audioControls">
        <button id="playAudioBtn" disabled>
          Play Audio (Feature Coming Soon)
        </button>
        <audio id="itemAudio" src=""></audio>
      </div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
      gps-entity-place="true"
      renderer="logarithmicDepthBuffer: true;"
    >
      <a-camera
        id="camera"
        look-controls-enabled="false"
        arjs-device-orientation-controls="smoothingFactor: 0.1"
        gps-new-camera="gpsMinDistance: 5"
      >
      </a-camera>
    </a-scene>

    <script>
      // Array of predefined items that can be placed in the AR scene.
      // Each item now includes a 'description' and a 'audioSrc' for future use.
      const itemsToPlace = [
        {
          name: "Mysterious Box",
          model: "assets/wolf_with_animations.glb",
          scale: "1 1 1",
          description:
            "This ancient box, covered in strange glyphs, seems to pulse with a faint energy. Perhaps it holds a secret!",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" // Example audio
        },
        {
          name: "Glimmering Orb",
          model: "assets/toon_cat_free.glb",
          scale: "0.8 0.8 0.8",
          description:
            "A perfectly smooth orb, reflecting light in mesmerizing patterns. Legends say it can reveal hidden truths.",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"
        },
        {
          name: "Weathered Totem",
          model: "assets/wolf_with_animations.glb",
          scale: "1.2 1.2 1.2",
          description:
            "Carved from an unknown wood, this totem stands as a silent guardian, weathered by countless seasons.",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3"
        },
        {
          name: "Ancient Scroll",
          model: "assets/toon_cat_free.glb",
          scale: "0.9 0.9 0.9",
          description:
            "Unfurling slightly, this scroll hints at forgotten lore and maps to untold riches.",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3"
        },
        {
          name: "Floating Gem",
          model: "assets/wolf_with_animations.glb",
          scale: "1.1 1.1 1.1",
          description:
            "This crystalline gem hums with a soft vibration, seemingly defying gravity as it hovers.",
          audioSrc:
            "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3"
        }
      ];

      // Get references to DOM elements
      const scene = document.querySelector("a-scene");
      const loader = document.querySelector(".arjs-loader");
      const messageBox = document.getElementById("messageBox");
      const messageText = document.getElementById("messageText");
      const currentLatSpan = document.getElementById("currentLat");
      const currentLonSpan = document.getElementById("currentLon");
      const descriptionPopup = document.getElementById("descriptionPopup");
      const popupItemName = document.getElementById("popupItemName");
      const popupDescription = document.getElementById("popupDescription");
      const playAudioBtn = document.getElementById("playAudioBtn");
      const itemAudio = document.getElementById("itemAudio");

      // Flag to ensure items are placed only once after initial location fix
      let itemsPlaced = false;

      /**
       * Displays a custom message box instead of using `alert()`.
       * @param {string} message - The message to display.
       */
      function showMessage(message) {
        messageText.textContent = message;
        messageBox.style.display = "block";
      }

      /**
       * Updates the on-screen Latitude and Longitude display.
       * @param {GeolocationPosition} position - The current geolocation position.
       */
      function updateLocationDisplay(position) {
        currentLatSpan.textContent = position.coords.latitude.toFixed(6);
        currentLonSpan.textContent = position.coords.longitude.toFixed(6);

        // Place items only once the first accurate location is obtained
        if (!itemsPlaced) {
          placeRandomItems(position.coords.latitude, position.coords.longitude);
          itemsPlaced = true; // Set flag to true after placing
        }
      }

      /**
       * Handles geolocation errors.
       * @param {GeolocationPositionError} error - The geolocation error object.
       */
      function handleLocationError(error) {
        loader.style.display = "none"; // Hide loader even if there's an error
        let errorMessage = "Error getting your location: ";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage +=
              "User denied the request for Geolocation. Please enable location access in your browser settings.";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage +=
              "Location information is unavailable (e.g., GPS signal lost).";
            break;
          case error.TIMEOUT:
            errorMessage +=
              "The request to get user location timed out. Please ensure good GPS signal.";
            break;
          case error.UNKNOWN_ERROR:
            errorMessage += "An unknown error occurred.";
            break;
        }
        showMessage(errorMessage);
        console.error("Geolocation error:", error);
      }

      /**
       * Places random AR items around the user's initial location.
       * This function is called only once after the first successful location fix.
       * @param {number} userLat - User's latitude.
       * @param {number} userLon - User's longitude.
       */
      function placeRandomItems(userLat, userLon) {
        loader.style.display = "none"; // Hide loader once location is obtained

        // Define the desired distance from the user (20 feet = ~6.096 meters)
        const desiredDistanceMeters = 6.096;
        const numberOfItems = 5; // How many items to place

        for (let i = 0; i < numberOfItems; i++) {
          const randomItem =
            itemsToPlace[Math.floor(Math.random() * itemsToPlace.length)];

          const randomAngle = Math.random() * 2 * Math.PI; // 0 to 2*PI radians

          // Calculate displacement in meters (dx for East-West, dy for North-South)
          const dx_meters = desiredDistanceMeters * Math.cos(randomAngle);
          const dy_meters = desiredDistanceMeters * Math.sin(randomAngle);

          // Approximate conversion factors from meters to degrees
          // 1 degree of latitude is approximately 111,139 meters
          const meters_per_degree_lat = 111139;
          // 1 degree of longitude varies by latitude: meters_per_degree_lon = 111139 * cos(latitude_in_radians)
          const meters_per_degree_lon =
            111139 * Math.cos((userLat * Math.PI) / 180);

          // Calculate the latitude and longitude offsets
          const offsetLat = dy_meters / meters_per_degree_lat;
          const offsetLon = dx_meters / meters_per_degree_lon;

          // Calculate the final item coordinates
          const itemLat = userLat + offsetLat;
          const itemLon = userLon + offsetLon;

          const itemEntity = document.createElement("a-entity");
          itemEntity.setAttribute(
            "gps-entity-place",
            `latitude: ${itemLat}; longitude: ${itemLon};`
          );
          itemEntity.setAttribute("gltf-model", randomItem.model);
          itemEntity.setAttribute("scale", randomItem.scale);
          itemEntity.setAttribute("look-at", "#camera");
          // Store the full item data on the entity for easy retrieval on click
          itemEntity.setAttribute("item-data", JSON.stringify(randomItem));
          itemEntity.setAttribute("cursor-listener", "");

          // Add a text label above the model
          const textEntity = document.createElement("a-text");
          textEntity.setAttribute("value", randomItem.name);
          textEntity.setAttribute("align", "center");
          textEntity.setAttribute("color", "white");
          textEntity.setAttribute("wrap-count", "20");
          textEntity.setAttribute("position", "0 1.5 0"); // Adjust vertical position above the model
          textEntity.setAttribute("scale", "2 2 2");
          itemEntity.appendChild(textEntity);

          scene.appendChild(itemEntity);

          console.log(
            `Placed ${randomItem.name} at Lat: ${itemLat.toFixed(
              6
            )}, Lon: ${itemLon.toFixed(
              6
            )} (Approx. ${desiredDistanceMeters}m from user's initial location)`
          );
        }
      }

      // --- Event Listeners and Initial Setup ---

      // A-Frame event listener: 'loaded' event fires when the A-Frame scene is ready.
      scene.addEventListener("loaded", () => {
        // Start watching position immediately to update display and place items
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(
            updateLocationDisplay,
            handleLocationError,
            {
              enableHighAccuracy: true,
              timeout: 20000,
              maximumAge: 0
            }
          );
        } else {
          loader.style.display = "none";
          showMessage(
            "Geolocation is not supported by your browser. This AR experience requires geolocation to function."
          );
          console.error("Geolocation is not supported by this browser.");
        }
      });

      // A-Frame component to handle clicks on AR entities.
      AFRAME.registerComponent("cursor-listener", {
        init: function () {
          this.el.addEventListener("click", function (evt) {
            // Retrieve the stored item data from the entity
            const itemData = JSON.parse(this.el.getAttribute("item-data"));

            // Populate and show the description popup
            popupItemName.textContent = itemData.name;
            popupDescription.textContent = itemData.description;

            // Set up audio (for future implementation)
            if (itemData.audioSrc) {
              itemAudio.src = itemData.audioSrc;
              playAudioBtn.disabled = false;
              playAudioBtn.textContent = "Play Audio";
              playAudioBtn.onclick = () => {
                if (itemAudio.paused) {
                  itemAudio.play();
                  playAudioBtn.textContent = "Pause Audio";
                } else {
                  itemAudio.pause();
                  playAudioBtn.textContent = "Play Audio";
                }
              };
            } else {
              playAudioBtn.disabled = true;
              playAudioBtn.textContent = "No Audio Available";
              itemAudio.src = ""; // Clear source
            }

            descriptionPopup.style.display = "block";
            console.log(`Clicked on: ${itemData.name}`);
          });
        }
      });

      // Stop audio if popup is closed
      descriptionPopup
        .querySelector(".close-btn")
        .addEventListener("click", () => {
          itemAudio.pause();
          itemAudio.currentTime = 0; // Reset audio to start
          playAudioBtn.textContent = "Play Audio (Feature Coming Soon)"; // Reset button text
        });
    </script>
  </body>
</html>
